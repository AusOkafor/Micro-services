<!-- 9f2365b6-2424-46c8-a013-986b635ef057 c2553dfd-5684-4175-adaf-1878db116285 -->
# Shopify Service Workflow App (Go) — Complete Plan (Hardened)

## Source of truth

- This plan is derived from the full spec in [`Infra.md`](D:/Desktop/Micro-service/Infra.md).
- Core positioning: make Shopify work for **services paid in stages** (deposit → milestones → approval gate → final payment).

## Key decisions (locked for MVP)

- **Architecture**: modular monolith.
- **Backend**: Go HTTP API.
- **DB**: PostgreSQL; app DB is the source of truth.
- **Milestone payment rail (MVP)**: **Draft Orders** (invoice/checkout links). Keep `internal/payment` as an interface so we can add Payment Links later.
- **Client portal**: token-based, read-only except explicit approve/request-changes and optional file upload.

## Non-negotiable product laws (invariants)

- **Approval gate**: final milestone is not payable until client explicitly approves.
- **Config snapshot**: Service pricing/milestones are snapshotted at purchase time; later config edits never mutate existing Services.
- **Completion law**: A Service can be `Completed` only if:
- final milestone is paid, **or**
- a merchant **admin override** exists with reason (audited).
- **State machine only**: service status changes must go through allowed transitions; no direct DB updates.
- **Idempotent webhooks**: retries must be safe; duplicates must not create duplicate Services/Milestones.
- **Every override is audited**: required reason; never exposed to client portal.

## Domain model (entities)

- **Shop**: store identity, access token, plan, install state.
- **ServiceProductConfig**: editable config for a Shopify product (deposit + milestone template). This is the *template*, not the instance.
- **Service**: purchased service instance tied to deposit order.
- includes `service_config_snapshot` (JSON) taken at creation.
- **Milestone**: ordered payable stages with strict math rules.
- **Approval**: explicit approval/revision record.
- includes `has_preview` boolean recorded at approval request time.
- **PortalToken**: client access token with expiry.
- **File** (optional MVP): preview/upload metadata.
- **AdminAction** (override): explicit merchant override actions + reason.
- **AuditLog**: immutable append-only log (raw, canonical).
- **ServiceEvent** (read model): derived/denormalized timeline for Admin UI + Portal (read-only).

## ServiceProductConfig lifecycle (locked behavior)

- **Where edited**: stored in app DB (`service_product_configs`), edited via merchant-admin endpoints.
- Optional later: mirror a minimal flag to Shopify metafields, but DB remains source of truth.
- **Snapshot rule**: when a Service is created, copy the relevant config into `services.service_config_snapshot` (JSONB).
- **Mid-service changes**: changing `service_product_configs` affects only *future* Services.

## Milestone calculator contract (money correctness)

Define template:

- `MilestoneTemplate { Type: fixed|percentage, Value: decimal, IsFinal: bool }`

Rules:

- **Deposit is milestone[0]** (sequence 0). Deposit is not special-cased.
- **Final milestone**: exactly one `IsFinal=true`, and it must be the last sequence.
- **Rounding**: all amounts stored as currency minor units or fixed decimal with consistent rounding; rounding differences are applied to the **final milestone** so totals match.
- **Sum rule**: `sum(milestones.amount) == service.total_amount` must validate at creation.
- **Validation**: refuse templates that would produce negative/zero milestones, more than N milestones per plan, or final not last.

## State machine

States:

- `Draft` → `Booked` → `InProgress` → `WaitingForApproval` → `Completed`
- Revision path: `WaitingForApproval` → `InProgress`

Guards:

- Transition must be validated.
- `Completed` requires the Completion law above.

## Database schema (tables + critical columns)

Create migrations for:

- `shops`
- `service_product_configs`
- `services`
- add `service_config_snapshot JSONB NOT NULL`
- add `completed_via_override BOOLEAN NOT NULL DEFAULT false`
- `milestones`
- `approvals`
- add `has_preview BOOLEAN NOT NULL DEFAULT false`
- `portal_tokens`
- `files` (optional MVP)
- `admin_actions`
- `audit_logs`
- `service_events` (read model)
- `webhook_events` (idempotency)

### `webhook_events` (explicit idempotency table)

Table:

- `webhook_events (
id UUID PK,
shop_id UUID,
topic TEXT,
event_id TEXT,
payload_hash TEXT,
processed_at TIMESTAMP
)`
- Constraint: `UNIQUE (shop_id, topic, event_id)`

### `admin_actions` (merchant override path)

Store:

- `service_id`, `action_type`, `reason`, `created_by` (merchant user / actor string), `created_at`, `metadata JSONB`

### `service_events` (read-only timeline)

Store denormalized events for UI:

- `service_id`, `event_type`, `summary`, `actor`, `occurred_at`, `data JSONB`
- Derived from AuditLog + domain actions; never edited directly.

Indexes/constraints:

- Unique: `shops.shop_domain`, `portal_tokens.token`
- FK: `services.shop_id`, `milestones.service_id`, `approvals.service_id`, `files.service_id`, `admin_actions.service_id`, `service_events.service_id`, `webhook_events.shop_id`

## External integrations (Shopify)

### OAuth + install

- Implement OAuth install/callback.
- Persist `shop_domain` + `access_token`.

### Webhooks (minimum)

- App uninstalled → purge shop data (within 48h).
- Order paid (deposit) → create Service + milestones from snapshot.
- Payment completion → resolve milestone paid; mark milestone paid; if final paid then complete (subject to Completion law).

### Milestone payments (Draft Order approach)

- Merchant requests payment → create Draft Order for milestone amount; store draft order ID/link on milestone.
- Payment webhook → map paid order to milestone and update atomically.

## API surface (v1) — disciplined contracts

### Error model (mandatory)

All non-2xx return:

- `{"error": {"code": "FINAL_MILESTONE_LOCKED", "message": "Final payment requires approval"}}`

Rules:

- **Stable `code`** for frontend branching.
- `message` is client-safe and non-sensitive.
- Internal errors are masked; internal details go to logs/traces.

### Merchant admin endpoints

Auth:

- `GET /v1/auth/install`
- `GET /v1/auth/callback`

Service product config:

- `GET /v1/service-products`
- `PUT /v1/service-products/{shopify_product_id}` (create/update config)

Services:

- `GET /v1/services`
- `GET /v1/services/{id}`
- `PATCH /v1/services/{id}/status`
- `GET /v1/services/{id}/events` (from `service_events`)

Milestones:

- `POST /v1/milestones/{id}/request-payment`

Approval (merchant side):

- `POST /v1/services/{id}/request-approval`
- records `approvals.has_preview` based on whether any preview files exist at request time

### Merchant override (explicit, guarded)

- `POST /v1/services/{id}/admin/override`

Rules:

- Merchant-auth only.
- Requires `reason`.
- Must create `admin_actions` + `audit_logs` entry.
- Never available to client portal.

Suggested override actions (MVP):

- `MARK_MILESTONE_PAID`
- `COMPLETE_SERVICE_WITHOUT_FINAL_PAYMENT`
- `REOPEN_SERVICE`

### Client portal endpoints

- `GET /v1/portal/{token}`
- `POST /v1/portal/{token}/approve`
- `POST /v1/portal/{token}/request-revision`
- `POST /v1/portal/{token}/files` (optional MVP)
- `GET /v1/portal/{token}/files` (optional MVP)

### Webhooks

- `POST /v1/webhooks/shopify/*` (verify signature; route by topic)

## Concurrency, race safety, and transaction boundaries (locked)

- All milestone/payment state changes occur in **DB transactions**.
- Use **row-level locks** for milestone resolution and payment request:
- `SELECT ... FOR UPDATE` on the target `milestones` row when generating a payment request.
- `SELECT ... FOR UPDATE` on the target `milestones` (and `services`) row(s) when applying a payment webhook.
- Enforce single-writer semantics per milestone:
- prevent two payment requests from creating two active checkout links concurrently.
- Webhook processing:
- write `webhook_events` first (or atomically) to guarantee idempotency under retries.

## Preview/approval rule (MVP)

- Approval can be requested **without** files (flexible).
- When approval is requested, record `approvals.has_preview` to show “preview attached” vs “no preview attached” for trust and later analytics.

## Merchant trust feature (cheap, high value)

- Approval/payment requests sent to clients should appear from the **merchant’s store identity** where possible (store email/domain), not only app branding.

## Go package / folder layout

- `cmd/api/main.go`
- `internal/auth`, `internal/shop`, `internal/service`, `internal/milestone`, `internal/approval`, `internal/payment`, `internal/portal`, `internal/webhook`, `internal/audit`, `internal/limits`
- add `internal/adminaction` (override handling)
- add `internal/events` (service_events derivation/read)
- `pkg/shopify`, `pkg/db`, `pkg/config`

## Security requirements

- Validate Shopify webhook signatures.
- Portal tokens: high-entropy, expiring, scoped to one service.
- Shop-scoped auth middleware; strict multi-tenant isolation.
- PII minimization.

## App Store compliance checklist (acceptance)

- Clear billing consent; use Shopify Billing API.
- Works on free/limited plan.
- Uninstall: delete data within 48h.
- Minimal scopes.
- Privacy policy, ToS, support contact, data deletion policy.

## Testing strategy (payments-grade)

Unit tests:

- State machine transitions + Completion law.
- Milestone template validation + rounding + sum rule.
- Approval gate locks final milestone.
- Admin overrides require reason + always audited.

Integration tests:

- Draft order creation + link persistence.
- Webhook idempotency using `webhook_events` uniqueness.
- Concurrency: double request-payment and double webhook delivery.

## Delivery phases

Phase 0: Foundations

- OAuth install + shop persistence + webhook verification + `webhook_events`.

Phase 1: Service core + snapshot

- ServiceProductConfig CRUD + snapshot into Services at creation.
- Service state machine.

Phase 2: Milestones + payments

- Milestone contract + draft-order payment requests.

Phase 3: Portal + approval

- Portal view + approve/revision + final unlock.
- Preview uploads optional; `has_preview` tracking.

Phase 4: Overrides + audit/events + compliance hardening

- AdminAction overrides.
- AuditLog + ServiceEvents read model.
- Uninstall deletion job + App Store docs.

## Notes on future swap (Payment Links)

- Implement `internal/payment` via interface; keep domain unchanged when adding Payment Links.

### To-dos

- [ ] Turn Infra.md into feature-level acceptance criteria and definition of done for MVP scope.
- [ ] Finalize Postgres schema (including service product config + webhook idempotency) and migration ordering.
- [ ] Define v1 API contracts (routes, payloads, auth requirements, error model) for merchant admin + portal.
- [ ] Map Shopify OAuth scopes, webhooks, and API calls for deposit detection and Draft Order milestone payments.
- [ ] Specify security controls: webhook signature validation, portal tokens, shop-scoped auth, PII minimization.
- [ ] Create a payment-safety test matrix (unit/integration/webhook simulation) covering approval gate + idempotency.
- [ ] Create App Store compliance checklist and data deletion/uninstall flow acceptance criteria.
- [ ] Define environments, config/secrets, migration rollout strategy, and initial monitoring/logging expectations.